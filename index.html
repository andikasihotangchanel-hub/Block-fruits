<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Game 3D Stabil</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
body { margin:0; overflow:hidden; background:black; }

#joystick{
  position:absolute;
  bottom:20px;
  left:20px;
  width:120px;
  height:120px;
  background:rgba(255,255,255,0.2);
  border-radius:50%;
}

#stick{
  position:absolute;
  width:50px;
  height:50px;
  background:white;
  border-radius:50%;
  left:35px;
  top:35px;
}

#jumpBtn{
  position:absolute;
  bottom:40px;
  right:40px;
  padding:15px 20px;
  background:red;
  color:white;
  border:none;
  border-radius:50%;
}
</style>
</head>
<body>

<div id="joystick"><div id="stick"></div></div>
<button id="jumpBtn">JUMP</button>

<script>

// ===== SCENE =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,5,12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ===== LIGHT =====
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,20,10);
scene.add(light);

// ===== GROUND =====
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshPhongMaterial({color:0x228B22})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ===== ROAD =====
const road = new THREE.Mesh(
  new THREE.PlaneGeometry(6,200),
  new THREE.MeshPhongMaterial({color:0x222222})
);
road.rotation.x = -Math.PI/2;
road.position.y = 0.01;
scene.add(road);

// ===== PLAYER =====
const player = new THREE.Group();

const body = new THREE.Mesh(
  new THREE.BoxGeometry(1,2,1),
  new THREE.MeshPhongMaterial({color:0x0044ff})
);
body.position.y = 1;
player.add(body);

const head = new THREE.Mesh(
  new THREE.BoxGeometry(1,1,1),
  new THREE.MeshPhongMaterial({color:0xffcc99})
);
head.position.y = 2.5;
player.add(head);

scene.add(player);

// ===== BUILDINGS =====
for(let i=-80;i<=80;i+=8){

  const left = new THREE.Mesh(
    new THREE.BoxGeometry(3,6,3),
    new THREE.MeshPhongMaterial({color:Math.random()*0xffffff})
  );
  left.position.set(-5,3,i);
  scene.add(left);

  const right = new THREE.Mesh(
    new THREE.BoxGeometry(3,6,3),
    new THREE.MeshPhongMaterial({color:Math.random()*0xffffff})
  );
  right.position.set(5,3,i);
  scene.add(right);
}

// ===== MOVEMENT =====
let moveForward = 0;
let moveSide = 0;
let velocityY = 0;
let canJump = true;

// ===== JOYSTICK =====
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

joystick.addEventListener("touchmove", e=>{
  const rect = joystick.getBoundingClientRect();
  const x = e.touches[0].clientX - rect.left - 60;
  const y = e.touches[0].clientY - rect.top - 60;

  stick.style.left = (x+35)+"px";
  stick.style.top = (y+35)+"px";

  moveForward = -y/60;
  moveSide = x/60;
});

joystick.addEventListener("touchend", ()=>{
  moveForward = 0;
  moveSide = 0;
  stick.style.left = "35px";
  stick.style.top = "35px";
});

// ===== PUTAR KAMERA PAKAI SENTUH LAYAR =====
let isDragging = false;
let previousX = 0;

document.addEventListener("touchstart", e=>{
  if(e.touches.length==1){
    isDragging = true;
    previousX = e.touches[0].clientX;
  }
});

document.addEventListener("touchmove", e=>{
  if(isDragging){
    const delta = e.touches[0].clientX - previousX;
    previousX = e.touches[0].clientX;
    camera.rotation.y -= delta * 0.005;
  }
});

document.addEventListener("touchend", ()=>{
  isDragging = false;
});

// ===== JUMP =====
document.getElementById("jumpBtn").onclick = ()=>{
  if(canJump){
    velocityY = 0.25;
    canJump = false;
  }
};

// ===== ANIMATE =====
function animate(){
  requestAnimationFrame(animate);

  const angle = camera.rotation.y;

  player.position.z += moveForward * Math.cos(angle);
  player.position.x += moveForward * Math.sin(angle);

  player.position.x += moveSide * Math.cos(angle);
  player.position.z -= moveSide * Math.sin(angle);

  velocityY -= 0.01;
  player.position.y += velocityY;

  if(player.position.y <= 0){
    player.position.y = 0;
    velocityY = 0;
    canJump = true;
  }

  // Kamera follow belakang player
  camera.position.x = player.position.x - Math.sin(angle)*10;
  camera.position.z = player.position.z - Math.cos(angle)*10;
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}

animate();

// resize
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
