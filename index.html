/* ===============================
   EVENT TAHUN BARU IMLEK
================================= */

// ===== CEK TANGGAL IMLEK =====
let isImlek = false;

function checkImlek(){
    const today = new Date();
    const year = today.getFullYear();

    // Perkiraan tanggal Imlek 2026-2028
    const imlekDates = {
        2026: "2026-02-17",
        2027: "2027-02-06",
        2028: "2028-01-26"
    };

    if(imlekDates[year]){
        const imlek = new Date(imlekDates[year]);
        if(
            today.getDate() === imlek.getDate() &&
            today.getMonth() === imlek.getMonth()
        ){
            isImlek = true;
        }
    }
}

checkImlek();

/* ===============================
   PERLUAS AREA SPAWN
================================= */

const spawnArea = new THREE.Mesh(
    new THREE.PlaneGeometry(80,80),
    new THREE.MeshLambertMaterial({color:0x66bb66})
);
spawnArea.rotation.x = -Math.PI/2;
spawnArea.position.set(0, -0.01, 0);
scene.add(spawnArea);


/* ===============================
   ATUR ULANG POSISI RUMAH
================================= */

houses.forEach((house,i)=>{
    house.position.x = (i % 4) * 35 - 60;
    house.position.z = Math.floor(i/4) * 35 - 60;
});


/* ===============================
   PARKOUR IMLEK
================================= */

let parkourBlocks = [];
let parkourFinished = false;

if(isImlek){

    for(let i=0;i<15;i++){

        const block = new THREE.Mesh(
            new THREE.BoxGeometry(6,2,6),
            new THREE.MeshLambertMaterial({
                color: i % 2 === 0 ? 0xff0000 : 0xffd700
            })
        );

        block.position.set(
            10,
            2 + (i*4),
            -20 - (i*10)
        );

        scene.add(block);
        parkourBlocks.push(block);
    }

}


/* ===============================
   CEK MENANG PARKOUR
================================= */

function checkParkourWin(){

    if(!isImlek || parkourFinished) return;

    const lastBlock = parkourBlocks[parkourBlocks.length-1];

    if(lastBlock){
        const dist = player.position.distanceTo(lastBlock.position);

        if(dist < 5){
            parkourFinished = true;
            showAdminEventButton();
        }
    }
}


/* ===============================
   TOMBOL ADMIN EVENT
================================= */

function showAdminEventButton(){

    if(!isImlek) return;

    const btn = document.createElement("button");
    btn.innerText = "ADMIN EVENT";
    btn.style.position = "absolute";
    btn.style.top = "150px";
    btn.style.right = "20px";
    btn.style.padding = "15px";
    btn.style.background = "gold";
    btn.style.fontWeight = "bold";
    btn.style.zIndex = "999";

    btn.onclick = function(){
        alert("Selamat! Kamu menjadi Admin Event Imlek ðŸŽ‰");
        player.material.color.set(0xffd700);
    }

    document.body.appendChild(btn);
}


/* ===============================
   UPDATE LOOP TAMBAHAN
================================= */

const oldAnimate = animate;

animate = function(){
    oldAnimate();
    checkParkourWin();
};/* ===============================
   EFEK PETASAN IMLEK
================================= */

let fireworks = [];

function createFirework(x, y, z){

    const particles = [];
    const particleCount = 80;

    for(let i=0;i<particleCount;i++){

        const geometry = new THREE.SphereGeometry(0.3,8,8);
        const material = new THREE.MeshBasicMaterial({
            color: Math.random() > 0.5 ? 0xff0000 : 0xffd700
        });

        const particle = new THREE.Mesh(geometry, material);

        particle.position.set(x,y,z);

        // arah acak
        particle.userData.velocity = new THREE.Vector3(
            (Math.random()-0.5)*2,
            Math.random()*2,
            (Math.random()-0.5)*2
        );

        scene.add(particle);
        particles.push(particle);
    }

    fireworks.push(particles);
}


/* ===============================
   UPDATE PETASAN
================================= */

function updateFireworks(){

    fireworks.forEach((group,gi)=>{
        group.forEach((p,pi)=>{

            p.position.add(p.userData.velocity);
            p.userData.velocity.y -= 0.05;

            // hilangkan kalau jatuh
            if(p.position.y < 0){
                scene.remove(p);
                group.splice(pi,1);
            }

        });
    });
}


/* ===============================
   MODIFIKASI MENANG PARKOUR
================================= */

// Simpan fungsi lama
const oldShowAdminEventButton = showAdminEventButton;

showAdminEventButton = function(){

    if(!isImlek) return;

    oldShowAdminEventButton();

    // Mulai petasan langsung
    for(let i=0;i<5;i++){
        setTimeout(()=>{
            createFirework(
                player.position.x,
                player.position.y + 15,
                player.position.z
            );
        }, i*600);
    }

};


/* ===============================
   TAMBAH KE LOOP ANIMATE
================================= */

const oldAnimateImlek = animate;

animate = function(){
    oldAnimateImlek();
    updateFireworks();
};
