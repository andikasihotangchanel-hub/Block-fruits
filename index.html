<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Open World Kota</title>
<style>
body { margin: 0; overflow: hidden; }
canvas { display: block; }
#info {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-family: Arial;
    background: rgba(0,0,0,0.5);
    padding: 8px;
}
</style>
</head>
<body>
<div id="info">WASD = Gerak | Mouse = Kamera | E = Masuk Rumah</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHT
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10,20,10);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.6));

// GROUND
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshStandardMaterial({color:0x4caf50})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// PLAYER
const player = new THREE.Group();

const body = new THREE.Mesh(
    new THREE.BoxGeometry(1,2,0.8),
    new THREE.MeshStandardMaterial({color:0x1565c0})
);
body.position.y = 2;

const head = new THREE.Mesh(
    new THREE.BoxGeometry(0.9,0.9,0.9),
    new THREE.MeshStandardMaterial({color:0xffcc99})
);
head.position.y = 3.5;

player.add(body);
player.add(head);
player.position.y = 0;
scene.add(player);

// CAMERA CONTROL
let yaw = 0;
let pitch = 0;
let distance = 8;

document.addEventListener("mousemove", (e)=>{
    yaw -= e.movementX * 0.002;
    pitch -= e.movementY * 0.002;
    pitch = Math.max(-1.2, Math.min(1.2, pitch));
});

// MOVEMENT
let keys = {};
document.addEventListener("keydown", e=> keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e=> keys[e.key.toLowerCase()] = false);

// BUILDINGS
let buildings = [];
function createBuilding(x,z){
    const height = Math.random()*6+4;
    const mesh = new THREE.Mesh(
        new THREE.BoxGeometry(4,height,4),
        new THREE.MeshStandardMaterial({color:Math.random()*0xffffff})
    );
    mesh.position.set(x,height/2,z);
    scene.add(mesh);
    buildings.push(mesh);
}

for(let i=-60;i<=60;i+=12){
    for(let j=-60;j<=60;j+=12){
        if(Math.random()>0.4){
            createBuilding(i,j);
        }
    }
}

// SIMPLE HOUSE (BISA MASUK)
const house = new THREE.Mesh(
    new THREE.BoxGeometry(6,4,6),
    new THREE.MeshStandardMaterial({color:0x8d6e63})
);
house.position.set(15,2,15);
scene.add(house);

let insideHouse = false;

document.addEventListener("keydown", (e)=>{
    if(e.key.toLowerCase()==="e"){
        if(player.position.distanceTo(house.position) < 6){
            insideHouse = !insideHouse;
            if(insideHouse){
                scene.background = new THREE.Color(0xaaaaaa);
                camera.position.set(0,3,5);
            }else{
                scene.background = new THREE.Color(0x87ceeb);
            }
        }
    }
});

// COLLISION
function checkCollision(newPos){
    for(let b of buildings){
        if(newPos.distanceTo(b.position) < 3){
            return true;
        }
    }
    return false;
}

// UPDATE
function update(){

    let speed = 0.2;
    let direction = new THREE.Vector3();

    if(keys["w"]) direction.z -= 1;
    if(keys["s"]) direction.z += 1;
    if(keys["a"]) direction.x -= 1;
    if(keys["d"]) direction.x += 1;

    direction.normalize();

    let moveX = direction.x * speed;
    let moveZ = direction.z * speed;

    let newPosition = player.position.clone();
    newPosition.x += moveX;
    newPosition.z += moveZ;

    if(!checkCollision(newPosition)){
        player.position.copy(newPosition);
    }

    // CAMERA FOLLOW
    let camX = player.position.x + distance * Math.sin(yaw) * Math.cos(pitch);
    let camZ = player.position.z + distance * Math.cos(yaw) * Math.cos(pitch);
    let camY = player.position.y + 4 + distance * Math.sin(pitch);

    camera.position.set(camX, camY, camZ);
    camera.lookAt(player.position);
}

// LOOP
function animate(){
    requestAnimationFrame(animate);
    update();
    renderer.render(scene,camera);
}
animate();

// RESIZE FIX
window.addEventListener("resize",()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
