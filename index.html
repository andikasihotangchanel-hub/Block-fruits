<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>City Engine V2</title>
<style>
body { margin:0; overflow:hidden; background:#87ceeb; }

/* Joystick */
#joystick {
    position:absolute;
    bottom:40px;
    left:40px;
    width:120px;
    height:120px;
    background:rgba(0,0,0,0.25);
    border-radius:50%;
    touch-action:none;
}
#stick {
    position:absolute;
    left:40px;
    top:40px;
    width:40px;
    height:40px;
    background:white;
    border-radius:50%;
}
</style>
</head>
<body>

<div id="joystick"><div id="stick"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>

<script>

/* ================= BASIC SETUP ================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,2000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

/* ================= LIGHT ================= */
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.2));

/* ================= GROUND ================= */
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(1000,1000),
    new THREE.MeshStandardMaterial({color:0x2e8b57})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

/* ================= PLAYER ================= */
const player = new THREE.Group();
scene.add(player);

const body = new THREE.Mesh(
    new THREE.BoxGeometry(0.7,1.6,0.4),
    new THREE.MeshStandardMaterial({color:0x0099ff})
);
body.position.y = 1.6;
player.add(body);

const head = new THREE.Mesh(
    new THREE.BoxGeometry(0.6,0.6,0.6),
    new THREE.MeshStandardMaterial({color:0xffcc99})
);
head.position.y = 2.6;
player.add(head);

function limb(x,y){
    const l = new THREE.Mesh(
        new THREE.BoxGeometry(0.25,1,0.25),
        new THREE.MeshStandardMaterial({color:0x222222})
    );
    l.position.set(x,y,0);
    player.add(l);
    return l;
}
const armL = limb(-0.6,1.8);
const armR = limb(0.6,1.8);
const legL = limb(-0.25,0.5);
const legR = limb(0.25,0.5);

/* ================= PHYSICS ================= */
let velocityY = 0;
const gravity = -0.01;
let onGround = true;

/* ================= WORLD BUILD ================= */
const obstacles = [];

for(let x=-200;x<=200;x+=20){
    for(let z=-200;z<=200;z+=20){
        if(Math.random()>0.3){
            const h = 10 + Math.random()*30;
            const building = new THREE.Mesh(
                new THREE.BoxGeometry(12,h,12),
                new THREE.MeshStandardMaterial({color:0x888888})
            );
            building.position.set(x,h/2,z);
            scene.add(building);

            obstacles.push(new THREE.Box3().setFromObject(building));
        }
    }
}

/* ================= INPUT ================= */
let move = {f:0,r:0};
let sprint = false;

document.addEventListener("keydown",e=>{
    if(e.key==="w") move.f=1;
    if(e.key==="s") move.f=-1;
    if(e.key==="a") move.r=-1;
    if(e.key==="d") move.r=1;
    if(e.key==="Shift") sprint=true;
    if(e.key===" ") jump();
});
document.addEventListener("keyup",e=>{
    if(e.key==="w"||e.key==="s") move.f=0;
    if(e.key==="a"||e.key==="d") move.r=0;
    if(e.key==="Shift") sprint=false;
});

/* ================= JOYSTICK ================= */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let drag=false;

joy.addEventListener("touchstart",()=>drag=true);
joy.addEventListener("touchend",()=>{
    drag=false;
    move.f=0; move.r=0;
    stick.style.left="40px";
    stick.style.top="40px";
});
joy.addEventListener("touchmove",e=>{
    if(!drag) return;
    const rect=joy.getBoundingClientRect();
    let x=e.touches[0].clientX-rect.left-60;
    let y=e.touches[0].clientY-rect.top-60;

    const max=40;
    x=Math.max(-max,Math.min(max,x));
    y=Math.max(-max,Math.min(max,y));

    stick.style.left=(60+x-20)+"px";
    stick.style.top=(60+y-20)+"px";

    move.r = x/max;
    move.f = -y/max;
});

/* ================= CAMERA CONTROL ================= */
let yaw=0;
let pitch=0;

renderer.domElement.onclick=()=>{
    renderer.domElement.requestPointerLock();
};

document.addEventListener("mousemove",e=>{
    if(document.pointerLockElement===renderer.domElement){
        yaw -= e.movementX*0.002;
        pitch -= e.movementY*0.002;
        pitch = Math.max(-Math.PI/3,Math.min(Math.PI/3,pitch));
    }
});

/* ================= COLLISION ================= */
function isColliding(pos){
    const playerBox = new THREE.Box3(
        new THREE.Vector3(pos.x-0.5,pos.y,pos.z-0.5),
        new THREE.Vector3(pos.x+0.5,pos.y+3,pos.z+0.5)
    );
    return obstacles.some(o=>playerBox.intersectsBox(o));
}

/* ================= JUMP ================= */
function jump(){
    if(onGround){
        velocityY = 0.25;
        onGround = false;
    }
}

/* ================= ANIMATION LOOP ================= */
let walk=0;

function animate(){
    requestAnimationFrame(animate);

    const speed = sprint ? 0.4 : 0.2;

    let dir=new THREE.Vector3();
    dir.x=Math.sin(yaw)*move.f + Math.cos(yaw)*move.r;
    dir.z=Math.cos(yaw)*move.f - Math.sin(yaw)*move.r;

    if(move.f!==0||move.r!==0){
        let newPos=player.position.clone().addScaledVector(dir,speed);
        if(!isColliding(newPos)){
            player.position.x=newPos.x;
            player.position.z=newPos.z;
        }

        walk+=0.25;
        armL.rotation.x=Math.sin(walk)*0.8;
        armR.rotation.x=-Math.sin(walk)*0.8;
        legL.rotation.x=-Math.sin(walk)*0.8;
        legR.rotation.x=Math.sin(walk)*0.8;
    } else {
        armL.rotation.x=armR.rotation.x=legL.rotation.x=legR.rotation.x=0;
    }

    /* Gravity */
    velocityY += gravity;
    player.position.y += velocityY;

    if(player.position.y <= 0){
        player.position.y = 0;
        velocityY = 0;
        onGround = true;
    }

    player.rotation.y = yaw;

    /* Third Person Camera */
    const camDistance = 6;
    const camHeight = 3;

    const camX = player.position.x - Math.sin(yaw)*camDistance;
    const camZ = player.position.z - Math.cos(yaw)*camDistance;
    const camY = player.position.y + camHeight + pitch*5;

    camera.position.set(camX,camY,camZ);
    camera.lookAt(player.position.x,player.position.y+2,player.position.z);

    renderer.render(scene,camera);
}
animate();

/* ================= RESIZE ================= */
onresize=()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
};

</script>
</body>
</html>
